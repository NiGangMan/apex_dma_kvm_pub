use serde::{Deserialize, Serialize};

use crate::{lock_mod, skyapex::offsets_loader::OffsetsLoader};

/// This struct is generated by the `export_custom_offsets!()` macro.
///
/// Modifications should not be made here.
#[repr(C)]
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CustomOffsets {
    pub offset_entitylist: u64,
    pub offset_local_ent: u64,
    pub offset_name_list: u64,
    pub offset_global_vars: u64,
    pub offset_levelname: u64,
    pub offset_clientstate: u64,
    pub offset_signonstate: u64,
    pub offset_host_map: u64,
    pub offset_entity_team: u64,
    pub offset_player_health: u64,
    pub offset_entity_shield: u64,
    pub offset_entity_maxshield: u64,
    pub offset_player_helmettype: u64,
    pub offset_player_armortype: u64,
    pub offset_entiry_name: u64,
    pub offset_entity_sign_name: u64,
    pub offset_centity_abs_velocity: u64,
    pub offset_visible_time: u64,
    pub offset_player_zooming: u64,
    pub offset_traversal_progress: u64,
    pub offset_traversal_starttime: u64,
    pub offset_platform_uid: u64,
    pub offset_weapon_name: u64,
    pub offset_off_weapon: u64,
    pub offset_wall_run_start_time: u64,
    pub offset_wall_run_clear_time: u64,
    pub offset_centity_flags: u64,
    pub offset_in_attack: u64,
    pub offset_in_toggle_duck: u64,
    pub offset_in_zoom: u64,
    pub offset_in_forward: u64,
    pub offset_in_jump: u64,
    pub offset_in_duck: u64,
    pub offset_in_use: u64,
    pub offset_player_life_state: u64,
    pub offset_bleed_out_state: u64,
    pub offset_centity_viewoffset: u64,
    pub offset_centity_origin: u64,
    pub offset_bones: u64,
    pub offset_studiohdr: u64,
    pub offset_cplayer_aimpunch: u64,
    pub offset_cplayer_camerapos: u64,
    pub offset_player_viewangles: u64,
    pub offset_breath_angles: u64,
    pub offset_observer_mode: u64,
    pub offset_ovserver_target: u64,
    pub offset_matrix: u64,
    pub offset_render: u64,
    pub offset_primary_weapon: u64,
    pub offset_active_weapon: u64,
    pub offset_bullet_speed: u64,
    pub offset_bullet_scale: u64,
    pub offset_weaponx_zoom_fov: u64,
    pub offset_weaponx_ammo_in_clip: u64,
    pub offset_centity_modelname: u64,
    pub offset_cplayer_timebase: u64,
    pub offset_cplayer_viewmodels: u64,
    pub offset_crosshair_last: u64,
    pub offset_input_system: u64,
    pub offset_weaponx_bitfield_from_player: u64,
    pub offset_entity_highlight_generic_context: u64,
}

#[no_mangle]
pub extern "C" fn export_offsets() -> CustomOffsets {
    let default_offsets = include_str!("../../resource/default/offsets.ini");
    let offsets_file_path = std::env::current_dir().unwrap().join("offsets.ini");
    if !offsets_file_path.exists() {
        std::fs::write(offsets_file_path, default_offsets).unwrap();
    }

    let mut sm = lock_mod!();
    sm.export_offsets();

    CustomOffsets {
        offset_entitylist: sm.offset_entitylist() as u64,
        offset_local_ent: sm.offset_local_ent() as u64,
        offset_name_list: sm.offset_name_list() as u64,
        offset_global_vars: sm.offset_global_vars() as u64,
        offset_levelname: sm.offset_levelname() as u64,
        offset_clientstate: sm.offset_clientstate() as u64,
        offset_signonstate: sm.offset_signonstate() as u64,
        offset_host_map: sm.offset_host_map() as u64,
        offset_entity_team: sm.offset_entity_team() as u64,
        offset_player_health: sm.offset_player_health() as u64,
        offset_entity_shield: sm.offset_entity_shield() as u64,
        offset_entity_maxshield: sm.offset_entity_maxshield() as u64,
        offset_player_helmettype: sm.offset_player_helmettype() as u64,
        offset_player_armortype: sm.offset_player_armortype() as u64,
        offset_entiry_name: sm.offset_entiry_name() as u64,
        offset_entity_sign_name: sm.offset_entity_sign_name() as u64,
        offset_centity_abs_velocity: sm.offset_centity_abs_velocity() as u64,
        offset_visible_time: sm.offset_visible_time() as u64,
        offset_player_zooming: sm.offset_player_zooming() as u64,
        offset_traversal_progress: sm.offset_traversal_progress() as u64,
        offset_traversal_starttime: sm.offset_traversal_starttime() as u64,
        offset_platform_uid: sm.offset_platform_uid() as u64,
        offset_weapon_name: sm.offset_weapon_name() as u64,
        offset_off_weapon: sm.offset_off_weapon() as u64,
        offset_wall_run_start_time: sm.offset_wall_run_start_time() as u64,
        offset_wall_run_clear_time: sm.offset_wall_run_clear_time() as u64,
        offset_centity_flags: sm.offset_centity_flags() as u64,
        offset_in_attack: sm.offset_in_attack() as u64,
        offset_in_toggle_duck: sm.offset_in_toggle_duck() as u64,
        offset_in_zoom: sm.offset_in_zoom() as u64,
        offset_in_forward: sm.offset_in_forward() as u64,
        offset_in_jump: sm.offset_in_jump() as u64,
        offset_in_duck: sm.offset_in_duck() as u64,
        offset_in_use: sm.offset_in_use() as u64,
        offset_player_life_state: sm.offset_player_life_state() as u64,
        offset_bleed_out_state: sm.offset_bleed_out_state() as u64,
        offset_centity_viewoffset: sm.offset_centity_viewoffset() as u64,
        offset_centity_origin: sm.offset_centity_origin() as u64,
        offset_bones: sm.offset_bones() as u64,
        offset_studiohdr: sm.offset_studiohdr() as u64,
        offset_cplayer_aimpunch: sm.offset_cplayer_aimpunch() as u64,
        offset_cplayer_camerapos: sm.offset_cplayer_camerapos() as u64,
        offset_player_viewangles: sm.offset_player_viewangles() as u64,
        offset_breath_angles: sm.offset_breath_angles() as u64,
        offset_observer_mode: sm.offset_observer_mode() as u64,
        offset_ovserver_target: sm.offset_ovserver_target() as u64,
        offset_matrix: sm.offset_matrix() as u64,
        offset_render: sm.offset_render() as u64,
        offset_primary_weapon: sm.offset_primary_weapon() as u64,
        offset_active_weapon: sm.offset_active_weapon() as u64,
        offset_bullet_speed: sm.offset_bullet_speed() as u64,
        offset_bullet_scale: sm.offset_bullet_scale() as u64,
        offset_weaponx_zoom_fov: sm.offset_weaponx_zoom_fov() as u64,
        offset_weaponx_ammo_in_clip: sm.offset_weaponx_ammo_in_clip() as u64,
        offset_centity_modelname: sm.offset_centity_modelname() as u64,
        offset_cplayer_timebase: sm.offset_cplayer_timebase() as u64,
        offset_cplayer_viewmodels: sm.offset_cplayer_viewmodels() as u64,
        offset_crosshair_last: sm.offset_crosshair_last() as u64,
        offset_input_system: sm.offset_input_system() as u64,
        offset_weaponx_bitfield_from_player: sm.offset_weaponx_bitfield_from_player() as u64,
        offset_entity_highlight_generic_context: sm.offset_entity_highlight_generic_context()
            as u64,
    }
}
